(function(){var a,b,c,d,e,f,g,h,i,j,k,l=Object.prototype.hasOwnProperty,m=function(a,b){function d(){this.constructor=a}for(var c in b)l.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},n=function(a,b){return function(){return a.apply(b,arguments)}},o=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};k=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,Backbone.Router),a}(),h=function(){function a(a,b,c){this.name=a,this.path=b,this.config=c}return m(a,Backbone.View),a}(),d=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,RemoteModel),a}(),i=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,d),a}(),a=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,d),a}(),g=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,h),a}(),f=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,g),a}(),e=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,g),a}(),j=function(){function a(){a.__super__.constructor.apply(this,arguments)}return m(a,ModelCollection),a.prototype.model=i,a}(),b=function(){function b(){b.__super__.constructor.apply(this,arguments)}return m(b,ModelCollection),b.prototype.model=a,b}(),c=function(){function a(a,b,c){this.id=a,this.el=$(this.id),this.config={physics:{theta:.8,charge:-100,gravity:.05,distance:100,friction:.9}},this.natives={node:null,edge:null,force:null,visualizer:null},this.index={filled_keys:[],nodes_by_key:{},edges_by_node:{},encountered_nodes:[],encountered_edges:[],encountered_hints:[]},this.state={drawn:!1,hidden:!1,locked:!1,"static":!1,rendered:!1},this.data={nodes:[],edges:[],hints:[],getNodes:n(function(){return this.data.nodes},this),getEdges:n(function(){return this.data.edges},this),getHints:n(function(){return this.data.hints},this),getNode:n(function(a){if(o.call(this.index.encountered_nodes,a)>=0)return this.index.nodes_by_key[a]},this),getEdge:n(function(a){var b;return b=edge.source.key.encoded+"::->::"+edge.target.key.encoded,this.index.edges_by_keypair(b)},this),getHint:n(function(a){if(o.call(this.index.encountered_hints,a)>=0)return this.data.hints[_.indexOf(this.index.encountered_hints,a)]},this),setNode:n(function(a){var b,c;return(c=a.key.encoded,o.call(this.index.encountered_nodes,c)<0)?(b=this.data.nodes.push(a)-1,this.index.nodes_by_key[a.key.encoded]={nindex:b,data:this.data.nodes[b]},this.index.edges_by_node[a.key.encoded]={outgoing:[],incoming:[]},this.index.encountered_nodes.push(a.key.encoded),b):_.indexOf(this.index.encountered_nodes,a.key.encoded)},this),setEdge:n(function(a,b){var c,d;return b==null?(b=this.data.nodes,a={source:this.data.nodes[a.source],target:this.data.nodes[a.target]}):a={source:this.data.nodes[b[a.source]],target:this.data.nodes[b[a.target]]},c=a.source.key.encoded+"::->::"+a.target.key.encoded,o.call(this.index.encountered_edges,c)<0?(d=this.data.edges.push(a)-1,this.index.edges_by_node[a.source.key.encoded].outgoing.push({eindex:d,target:this.data.getNode(a.target.key.encoded)}),this.index.edges_by_node[a.target.key.encoded].incoming.push({eindex:d,source:this.data.getNode(a.source.key.encoded)}),this.index.encountered_edges.push(c),d):_.indexOf(this.index.encountered_edges,c)},this),setHint:n(function(a,b){var c,d;return(d=a.key.encoded,o.call(this.index.encountered_hints,d)<0)?(c=this.data.hints.push(a)-1,this.index.encountered_hints.push(a.key.encoded),c):_.indexOf(this.index.encountered_hints,a.key.encoded)},this)}}return m(a,h),a.prototype.build=function(a,b,c){var d;return b==null&&(b=!0),c==null&&(c=!1),d=$.fatcatmap.rpc.api.graph.construct(a),d.fulfill({success:n(function(a){var d,e,f;f=[],_.each(a.graph.vertices,n(function(a,b){return f.push(this.data.setNode(a))},this)),d=[],_.each(a.graph.vectors,n(function(a){return d.push(this.data.setEdge(a,f))},this)),e=[],_.each(a.graph.hints,n(function(a){return e.push(this.data.setHint(a,d))},this)),this.draw(),this.fill(b,c)},this),failure:n(function(a){return $.fcm.dev.error("Graph","Could not complete graph build operation.",a),alert("Could not construct graph.")},this)}),this},a.prototype.fill=function(a,b){var c,d,e,f,g,h,i,j,k;a==null&&(a=!0),b==null&&(b=!1),e=[],g=[],a&&g.push(this.index.encountered_nodes),b&&g.push(this.index.encountered_edges);for(h=0,j=g.length;h<j;h++){f=g[h];for(i=0,k=f.length;i<k;i++)d=f[i],o.call(this.index.filled_keys,d)<0&&e.push(d)}return d.length>0&&(c=$.fatcatmap.rpc.api.data.get({keys:e}),c.fulfill({success:this._dataSuccessCallback,failure:this._dataFailureCallback})),this},a.prototype._dataSuccessCallback=function(a){return console.log("data response",a)},a.prototype._dataFailureCallback=function(a){return console.log("data error",a)},a.prototype.render=function(){var a;return a=$(this.el),this.state.rendered===!1&&(this.natives.visualizer=d3.select(this.id).append("svg:svg").attr("width",this.el.width()).attr("height",this.el.height()),this.natives.visualizer.style("opacity",1e-6).transition().duration(1500).style("opacity",1)),this.state.rendered=!0,this},a.prototype.draw=function(){return this.natives.force=d3.layout.force().charge(this.config.physics.charge).gravity(this.config.physics.gravity).distance(this.config.physics.distance).theta(this.config.physics.theta).friction(this.config.physics.friction).nodes(this.data.getNodes()).links(this.data.getEdges()).size([this.el.width(),this.el.height()]).start(),this.natives.edge=this.natives.visualizer.selectAll("line.link").data(this.data.getEdges()).enter().append("svg:line").attr("data-source-node-key",function(a){return a.source.key.encoded}).attr("data-target-node-key",function(a){return a.target.key.encoded}).attr("class","edge").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),this.natives.node=this.natives.visualizer.selectAll("g.node").data(this.data.getNodes()).enter().append("svg:g").attr("id",function(a){return a.key.encoded}).attr("class","node").attr("data-kind",function(a){return a.kind}).attr("data-label",function(a){return a.label}).attr("data-object-key",function(a){return a.key.parent}).call(this.natives.force.drag).on("click",n(function(a){return $("#nodekey").text(a.key.encoded),$("#nodelabel").text(a.label),detailspane.unfold()},this)),this.natives.node.append("svg:circle").attr("class","circle").attr("x","-8px").attr("y","-8px").attr("r",16),this.natives.node.append("svg:text").attr("x",-4).attr("y",4).attr("class","label").text(n(function(a){return this.data.getNode(a.key.encoded).nindex.toString()},this)),this.natives.force.on("tick",n(function(){return this.natives.edge.attr("x1",function(a,b){return a.source.x}).attr("y1",function(a,b){return a.source.y}).attr("x2",function(a,b){return a.target.x}).attr("y2",function(a,b){return a.target.y}),this.natives.node.attr("transform",function(a,b){return"translate("+a.x+","+a.y+")"}).attr("cx",function(a,b){return a.x}).attr("cy",function(a,b){return a.y}),this.natives.force.charge(this.config.physics.charge).gravity(this.config.physics.gravity).distance(this.config.physics.distance).theta(this.config.physics.theta).friction(this.config.physics.friction)},this)),this.state.drawn=!0,this},a}(),window.Models.GraphArtifact=d,window.Models.Node=i,window.Models.Edge=a,window.Interaction={GraphSprite:g,GraphNode:f,GraphEdge:e,NodeCollection:j,EdgeCollection:b,Graph:c}}).call(this)