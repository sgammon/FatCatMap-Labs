/*
jQuery.sql - webSQL plugin for jQuery, version 0.8a

    Copyright (C) 2011 Pedro Costa Coitinho

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
(function($){function _countObj(obj){var tot=0;for(var i in obj){if(i!=='__table'){tot++;}}
return tot;}
$.sql={checkSupport:function(){if(window.openDatabase){return true;}else{return false;}},open:function(properties){if(window.openDatabase){var db=$(window).data('db');if(!db){if(!properties){var properties={}};properties.name=properties.name||'app';properties.version=properties.verstion||'1.0';properties.description=properties.description||'Application database';properties.size=properties.size||1024*1024;properties.callback=properties.callback||function(){};db=openDatabase(properties.name,properties.version,properties.description,properties.size,properties.createCallback);$(window).data('db',db);}else{$.error('SQL error: Database is already open');}}else{$.error('SQL error: No databse support');}
return $;},query:function(query,properties){if(!properties){var properties={};}
properties.arguments=properties.arguments||[];properties.success=properties.success||function(){};properties.failure=properties.failure||function(message){$.error(message);};if(!(query instanceof Array)){query=[query];}
var db=$(window).data('db');if(!db){$.error('SQL error: Database not open or not supported');}else if(!query){$.error('SQL error: No query to parse');}else{db.transaction(function(tx){for(var i=0;i<query.length;i++){tx.executeSql(query[i],properties.arguments,function(tx,results){if(results.rowsAffected>0||results.rows.length>0){properties.success(results.rows);}else{properties.success(false);}},function(tx,message){properties.failure(message.message)});}},null);}
return $;},setColumns:function(columns){$(window).data('dbActiveRecord',columns);return $;},addColumn:function(name,value){var columns=$(window).data('dbActiveRecord');if(!columns){columns={}}
columns[name]=value;$(window).data('dbActiveRecord',ar);return $;},removeColumn:function(name){var columns=$(window).data('dbActiveRecord');if(columns){if(columns[name]){delete columns[name];$(window).data('dbActiveRecord',columns);}else{$.error('SQL Active Record Error: Column '+name+' does not exist :(');}}else{$.error('SQL Active Record Error: No coluns to remove from');}
return $;},setTable:function(name){var columns=$(window).data('dbActiveRecord');if(!columns){columns={};}
columns.__table=name;$(window).data('dbActiveRecord',columns);return $},createTable:function(name){var columns=$(window).data('dbActiveRecord');if(columns){if(columns.name||name){var query='CREATE TABLE IF NOT EXISTS '+name+' (';var length=_countObj(columns),count=0;for(var i in columns){if(i!=='__table'){query+=i+' '+columns[i];if(count<length-1){query+=', ';count++;}
count++;}}
query+=')';columns.__table=name;$(window).data('dbActiveRecord',columns);$.sql.query(query);}else{$.error('SQL Active Record Error: No table name specified');}}else{$.error('SQL Active Record Error: No columns specified');}
return $;},addRow:function(){if(arguments.length>0){var columns=$(window).data('dbActiveRecord');if(columns){function _activeRecordQuery(row){var query='INSERT INTO '+columns.__table+' ('
var length=_countObj(columns),count=0;for(i in columns){if(i!=='__table'){query+=i;if(count<length-1){query+=', ';}
count++;}}
query+=') VALUES ('
count=0;for(i in columns){if(i!=='__table'){if(typeof row[count]==='string'){query+='"'+row[count]+'"';}else{query+=row[count];}
if(count<length-1){query+=', ';}
count++;}}
return query+')';}
if(arguments[0]instanceof Array){var query=[];for(var i=0;i<arguments.length;i++){query[i]=_activeRecordQuery(arguments[i]);}}else{var query=_activeRecordQuery(arguments);}
$.sql.query(query);}else{$.error('SQL Active Record Error: No properties set');}}else{$.error('SQL Active Record Error: No arguments in addRow()');}
return $;}};var methods={load:function(properties){var query='SELECT '+properties.fetchColumns+' FROM '+properties.table;query+=(properties.condition?' WHERE '+properties.condition:'');query+=(properties.limit?' LIMIT '+properties.start+', '+properties.limit:'');var obj=this;$.sql.query(query,{success:function(rows){if(rows){for(var i=0;i<rows.length;i++){var row=$(properties.rowWrap);for(var j in rows.item(i)){row.append($(properties.columnWrap).html(rows.item(i)[j]));}
obj.append(row);}
if(properties.limit){properties.start+=properties.limit;obj.data('db',properties);}}else{$(obj).data('db').failure.call(obj);}}});return $;},};$.fn.sql=function(method,propertiesDelta){var properties=this.data('db');if(!properties){properties={};properties.columnWrap='<td></td>';properties.rowWrap='<tr></tr>';properties.start=0;properties.limit=false;properties.condition=false;properties.table='';properties.fetchColumns='*';properties.failure=function(){$.error('SQL fn: Query returned no results');};this.data('db',properties);}
if(propertiesDelta){properties.columnWrap=propertiesDelta.columnWrap||properties.columnWrap;properties.rowWrap=propertiesDelta.rowWrap||properties.rowWrap;properties.start=propertiesDelta.start||properties.start;properties.limit=propertiesDelta.limit||properties.limit;properties.condition=propertiesDelta.condition||properties.condition;properties.table=propertiesDelta.table||properties.table;properties.fetchColumns=propertiesDelta.fetchColumns||properties.fetchColumns;properties.failure=propertiesDelta.failure||properties.failure;this.data('db',properties);}
if(methods[method]){methods[method].call(this,properties);}else{$.error('SQL error: Method '+method+' doesnt exist!');}
return $;};})(jQuery);